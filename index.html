<!DOCTYPE html>
<html>
<head>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://d3js.org/topojson.v2.min.js"> </script>
</head>

<body>
  <svg class="stateMap" height="650" width="1000" style="background-color:darksalmon">

  <style>
    .regionText {
      font-weight: bold;
      font-family: Helvetica, Arial, Sans-serif;
      text-shadow: 2px 1px 5px white;
    }

    #chartTitle {
      font-weight: bold;
      font-size: 22px;
      font-family: Helvetica, Arial, Sans-serif;
    }
  </style>

  </svg>
  <script>
      const svg = d3.select(".stateMap");
      const height = svg.attr("height");
      const width = svg.attr("width");
      const margin = {top: 30, right: 30, bottom: 30, left: 30};
      const mapWidth = width- margin.right - margin.left;
      const mapHeight = height - margin.top - margin.bottom;
      const usMap = svg.append("g").attr("transform","translate("+margin.left+","+margin.top+")");

      const visualizeData = async() => {

      // Create Map
      const usData = await d3.json("../datasets/us.json");
      let usStates = topojson.feature(usData, usData.objects.states);
      let project = d3.geoAlbersUsa().fitSize([mapWidth, mapHeight], usStates);
      let path = d3.geoPath().projection(project);

      usMap.selectAll("path").data(usStates.features)
        .enter()
        .append("path")
        .attr("class", "state")
        .style("fill", "white")
        .style("stroke", "none")
        .attr("d", path)
        .attr("note", d => d.id);

      usMap.append("path")
        .datum(topojson.mesh(usData, usData.objects.states))
        .style("stroke", "black")
        .style("fill", "none")
        .attr("note", d=> d.id)
        .attr("d", path);

      nameData = await d3.tsv("../datasets/us-state-names.tsv");

      // IMPORT GRAD SALARIES DATASET
      const gradSalaries = await d3.csv("../datasets/grad-salaries-by-region.csv");

      // Initialize starting salaries
      const southernStartingSalaries = [];
      const westernStartingSalaries = [];
      const midwesternStartingSalaries = [];
      const californiaStartingSalaries = [];
      const northeasternStartingSalaries = [];

      let regionSalaries = [];

      function findMedian(dataset) {
        dataset.sort((a,b) => a - b);

        let middle = Math.floor(dataset.length / 2);

        if(dataset.length % 2) {
          return Number(dataset[middle]);

        } else {
          return ((Number(dataset[middle-1]) + Number(dataset[middle])) / 2);
        }
      };

      // Sanitizes starting median salaries for college graduates and splits by region
      gradSalaries.forEach((d) => {
        d["Starting Median Salary"] = Number(d["Starting Median Salary"].replace(/,/g,"").replace("$",""));

        if (d["Region"] == "Southern") {
          southernStartingSalaries.push(d["Starting Median Salary"]);

        } else if (d["Region"] == "Western") {
          westernStartingSalaries.push(d["Starting Median Salary"]);

        } else if (d["Region"] == "Midwestern") {
          midwesternStartingSalaries.push(d["Starting Median Salary"]);

        } else if (d["Region"] == "California") {
          californiaStartingSalaries.push(d["Starting Median Salary"]);

        } else if (d["Region"] == "Northeastern") {
          northeasternStartingSalaries.push(d["Starting Median Salary"]);
        }
      });

      regionSalaries.push({region: "Southern", median: findMedian(southernStartingSalaries)});
      regionSalaries.push({region: "Western", median: findMedian(westernStartingSalaries)});
      regionSalaries.push({region: "Midwestern", median: findMedian(midwesternStartingSalaries)});
      regionSalaries.push({region: "California", median: findMedian(californiaStartingSalaries)});
      regionSalaries.push({region: "Northeastern", median: findMedian(northeasternStartingSalaries)});

      console.log(regionSalaries);

      let currentState = [];
      let currentStateName = "";
      var stateMedianIncomes = [];

      // IMPORT STATE INCOMES DATASET
      d3.csv("../datasets/incomes-by-state.csv").then( function(data) {
        data.forEach(function(row) {
          if (currentState.length == 0) {
            currentStateName = row.State_Name;
            currentState.push(row.Median);

          }

          if (currentStateName != row.State_Name) {
            stateMedianIncomes.push({state: currentStateName, median: findMedian(currentState)});

            // let sum = 0;
            // for (i = 0; i < currentState.length; i++ ) {
            //   sum += Number(currentState[i]);
            // }
            //
            // let mean = sum / currentState.length;
            //
            // stateMeanIncomes.push({state: currentStateName, mean: mean});
            currentState = [];
            currentStateName = row.State_Name;
            currentState.push(row.Median);

          } else {
            currentState.push(row.Median);
          }
        });

        console.log(stateMedianIncomes);

        //SIMPLIFYING STATE TO MEDIAN DATA ARRAY
        state_Median = {};
        stateMedianIncomes.forEach(function(row) {
          state_Median[row.state] = row.median;
        });

        state_ID = {};
        nameData.forEach(row => {
          state_ID[row.id] = row.name;
        })

        minMedian = d3.min(stateMedianIncomes, function(d) { return Math.min(d["median"]); });
        maxMedian = d3.max(stateMedianIncomes, function(d) { return Math.max(d["median"]); });

        // console.log("Min: " + minMedian);
        // console.log("Max: " + maxMedian);

        let colorScale = d3.scaleSequential().interpolator(d3.interpolate("#f7fbff", "#08306b")).domain([minMedian,maxMedian]);

        usMap.selectAll(".state").style("fill", d => colorScale( state_Median[state_ID[d.id]]));
      });

      minRegionMedian = d3.min(regionSalaries, function(d) { return Math.min(d["median"]); });
      maxRegionMedian = d3.min(regionSalaries, function(d) { return Math.max(d["median"]); });

      let radiusScale = d3.scaleLinear()
          .domain([40000, 50000])
          .range([60, 120]);

      let regionCircles = svg.append("g").attr("class", "region circles")
        .attr("transform","translate("+margin.left+","+margin.top+")");

      regionSalaries.forEach(function(region) {
        console.log(region.region + ": " + region.median + ", " + radiusScale(region.median));
        if(region.region == "California") {
          regionCircles.append("circle")
            .attr("cx", 120)
            .attr("cy", 290)
            .attr("r", radiusScale(region.median))
            .attr("fill", "#EFD494")
            .attr("fill-opacity", .60);
          regionCircles.append("text")
            .attr("class", "regionText")
            .attr("x", 120)
            .attr("y", 280)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "central")
            .text(region.region);
          regionCircles.append("text")
            .attr("class", "regionText")
            .attr("x", 120)
            .attr("y", 300)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "central")
            .text("$" + region.median);

        } if(region.region == "Southern") {
          regionCircles.append("circle")
            .attr("cx", 650)
            .attr("cy", 400)
            .attr("r", radiusScale(region.median))
            .attr("fill", "#EFD494")
            .attr("fill-opacity", .60);
          regionCircles.append("text")
              .attr("class", "regionText")
              .attr("x", 650)
              .attr("y", 390)
              .attr("text-anchor", "middle")
              .attr("dominant-baseline", "central")
              .text(region.region);
          regionCircles.append("text")
              .attr("class", "regionText")
              .attr("x", 650)
              .attr("y", 410)
              .attr("text-anchor", "middle")
              .attr("dominant-baseline", "central")
              .text("$" + region.median);

        } if(region.region == "Northeastern") {
          regionCircles.append("circle")
            .attr("cx", 880)
            .attr("cy", 150)
            .attr("r", radiusScale(region.median))
            .attr("fill", "#EFD494")
            .attr("fill-opacity", .60);
          regionCircles.append("text")
            .attr("class", "regionText")
            .attr("x", 880)
            .attr("y", 140)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "central")
            .text(region.region);
          regionCircles.append("text")
            .attr("class", "regionText")
            .attr("x", 880)
            .attr("y", 160)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "central")
            .text("$" + region.median);

        } if(region.region == "Midwestern") {
          regionCircles.append("circle")
            .attr("cx", 520)
            .attr("cy", 200)
            .attr("r", radiusScale(region.median))
            .attr("fill", "#EFD494")
            .attr("fill-opacity", .60);
          regionCircles.append("text")
            .attr("class", "regionText")
            .attr("x", 520)
            .attr("y", 190)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "central")
            .text(region.region);
          regionCircles.append("text")
            .attr("class", "regionText")
            .attr("x", 520)
            .attr("y", 210)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "central")
            .text("$" + region.median);

        } if(region.region == "Western") {
          regionCircles.append("circle")
            .attr("cx", 300)
            .attr("cy", 220)
            .attr("r", radiusScale(region.median))
            .attr("fill", "#EFD494")
            .attr("fill-opacity", .60);
          regionCircles.append("text")
            .attr("class", "regionText")
            .attr("x", 300)
            .attr("y", 210)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "central")
            .text(region.region);
          regionCircles.append("text")
            .attr("class", "regionText")
            .attr("x", 300)
            .attr("y", 230)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "central")
            .text("$" + region.median);
        }
      });

      //TITLE
      let mapTitle = svg.append("g").attr("class", "title")
        .attr("transform","translate("+margin.left+","+margin.top+")");
        mapTitle.append("text").attr("id", "chartTitle")
          .attr("x", (mapWidth/2))
          .attr("y", (0))
          .attr("text-anchor", "middle")
          .text("Median Starting Salary of College Graduates by Region Compared to Median Income by State");
    }

    visualizeData();
  </script>

</body>

</html>
